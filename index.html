<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>IA Stable Upscaler</title>
    <script src="https://unpkg.com/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
    <script src="https://unpkg.com/upscaler@0.14.0/dist/browser/umd/upscaler.min.js"></script>
    
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #fafafa; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 12px; shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #status { padding: 10px; margin: 10px; border-radius: 5px; background: #eee; font-weight: bold; }
        .preview { max-width: 100%; margin-top: 10px; border: 1px solid #ddd; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>Am√©liorateur IA</h2>
    
    <div id="status">‚è≥ Initialisation de l'IA...</div>
    
    <input type="file" id="fileInput" accept="image/*">
    <br>
    <button id="upscaleBtn">üöÄ Am√©liorer la qualit√©</button>

    <div>
        <canvas id="canvas" style="display:none;"></canvas>
        <p>Aper√ßu :</p>
        <img id="outputImg" class="preview">
    </div>
</div>

<script>
    let upscaler;

    // Fonction de v√©rification imm√©diate
    function checkLibraries() {
        if (typeof tf !== 'undefined' && typeof Upscaler !== 'undefined') {
            try {
                upscaler = new Upscaler();
                document.getElementById('status').innerText = "‚úÖ IA Pr√™te";
                document.getElementById('status').style.background = "#d4edda";
            } catch (e) {
                document.getElementById('status').innerText = "‚ùå Erreur CPU/GPU";
            }
        } else {
            // Re-tente toutes les secondes si les scripts ne sont pas charg√©s
            setTimeout(checkLibraries, 1000);
        }
    }

    checkLibraries();

    const fileInput = document.getElementById('fileInput');
    const upscaleBtn = document.getElementById('upscaleBtn');
    const outputImg = document.getElementById('outputImg');
    const status = document.getElementById('status');

    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                outputImg.src = event.target.result;
                upscaleBtn.style.display = 'inline-block';
            };
            reader.readAsDataURL(file);
        }
    };

    upscaleBtn.onclick = async () => {
        status.innerText = "‚è≥ Traitement en cours... Patientez.";
        upscaleBtn.disabled = true;

        try {
            // Utilisation d'un patch pour √©viter les erreurs de m√©moire
            const result = await upscaler.upscale(outputImg.src, {
                patchSize: 64, // D√©coupe l'image en petits morceaux pour ne pas faire planter le navigateur
                padding: 2
            });
            outputImg.src = result;
            status.innerText = "‚ú® Termin√© !";
        } catch (err) {
            status.innerText = "‚ùå Trop lourd pour votre navigateur.";
            console.error(err);
        } finally {
            upscaleBtn.disabled = false;
        }
    };
</script>
</body>
</html>
